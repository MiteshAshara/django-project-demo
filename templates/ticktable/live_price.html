{% extends 'base.html' %}

{% block title %}Live BTC/USDT Price{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h2 class="text-center m-0">Current Live Price: <span id="live-price-display">{{ latest_price }}</span></h2>
                    <p class="text-center text-light mb-0 mt-2">Last updated: <span id="last-update-time">Loading...</span> <span id="saved-indicator" class="badge badge-success ml-2">Saved</span></p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h3 class="m-0">Price History</h3>
                    <div>
                        <span class="badge badge-light" id="total-records">Loading...</span>
                        <span class="badge badge-info ml-2">Updates every second</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Price (USDT)</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Seconds Ago</th>
                                </tr>
                            </thead>
                            <tbody id="price-table-body">
                                <tr>
                                    <td colspan="5" class="text-center">Loading price data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <nav aria-label="Price history pagination" id="pagination-container">
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceDisplay = document.getElementById('live-price-display');
    const lastUpdateTime = document.getElementById('last-update-time');
    const savedIndicator = document.getElementById('saved-indicator');
    const tableBody = document.getElementById('price-table-body');
    const totalRecords = document.getElementById('total-records');
    const paginationContainer = document.getElementById('pagination-container');
    
    let currentPage = 1;
    let prices = [];
    let socket;
   
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return {
            date: date.toLocaleDateString(),
            time: date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}),
            secondsAgo: Math.round((new Date() - date) / 1000)
        };
    }
    
    function fetchPriceHistory(page = 1) {
        fetch(`/ticktable/api/price-history/?page=${page}`)
            .then(response => response.json())
            .then(data => {
                prices = data.prices;
                totalRecords.textContent = `${data.total_entries} Records`;
                
                renderPriceTable(prices);
                
                renderPagination(data.current_page, data.total_pages);
                
                currentPage = data.current_page;
            })
            .catch(error => {
                console.error('Error fetching price history:', error);
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error loading price data. Try refreshing the page.</td></tr>`;
            });
    }
    
    function renderPriceTable(prices) {
        if (prices.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No price data available</td></tr>`;
            return;
        }
        
        let tableHtml = '';
        const now = new Date();
        
        prices.forEach(price => {
            const formattedTime = formatDateTime(price.timestamp);
            tableHtml += `
                <tr>
                    <td>${price.id}</td>
                    <td>${parseFloat(price.live_price).toFixed(10)}</td>
                    <td>${formattedTime.date}</td>
                    <td>${formattedTime.time}</td>
                    <td>${formattedTime.secondsAgo} seconds</td>
                </tr>
            `;
        });
        
        tableBody.innerHTML = tableHtml;
    }
    
    
    function updateSecondsAgo() {
        const rows = tableBody.querySelectorAll('tr');
        const now = new Date();
        
        rows.forEach((row, index) => {
            if (prices[index]) {
                const timestamp = new Date(prices[index].timestamp);
                const secondsAgo = Math.round((now - timestamp) / 1000);
                row.cells[4].textContent = `${secondsAgo} seconds`;
            }
        });
    }
    
    function renderPagination(currentPage, totalPages) {
        let paginationHtml = `
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="1">First</a>
                </li>
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                </li>
        `;
        
        paginationHtml += `
            <li class="page-item active">
                <span class="page-link">Page ${currentPage} of ${totalPages}</span>
            </li>
        `;
        
        paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${totalPages}">Last</a>
                </li>
            </ul>
        `;
        
        paginationContainer.innerHTML = paginationHtml;
      
        document.querySelectorAll('.page-link[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const page = parseInt(this.getAttribute('data-page'));
                fetchPriceHistory(page);
            });
        });
    }

    function connectWebSocket() {
        socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
        
        socket.onopen = function() {
            console.log('WebSocket connected');
        };
        
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const price = parseFloat(data.c).toFixed(10);
            
            // Update price display
            priceDisplay.textContent = price;
            
            // Update last update time
            const now = new Date();
            lastUpdateTime.textContent = now.toLocaleTimeString();
            
            // Save price to database and show indicator
            savePrice(price);
        };
        
        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        socket.onclose = function() {
            console.log('WebSocket connection closed, attempting to reconnect...');
            setTimeout(connectWebSocket, 5000);
        };
    }
    
  
    function savePrice(price) {
        savedIndicator.textContent = 'Saving...';
        savedIndicator.classList.remove('badge-success', 'badge-danger');
        savedIndicator.classList.add('badge-warning');
        
        fetch('/ticktable/api/update-price/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ price: price })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                savedIndicator.textContent = 'Saved';
                savedIndicator.classList.remove('badge-warning', 'badge-danger');
                savedIndicator.classList.add('badge-success');
                
                if (currentPage === 1) {
                 
                    prices.unshift({
                        id: data.id,
                        live_price: data.price,
                        timestamp: data.timestamp
                    });
                    
                  
                    if (prices.length > 100) {
                        prices.pop();
                    }
                   
                    renderPriceTable(prices);
                    
                   
                    const current = parseInt(totalRecords.textContent.split(' ')[0]) || 0;
                    totalRecords.textContent = `${current + 1} Records`;
                }
            } else {
                savedIndicator.textContent = 'Error';
                savedIndicator.classList.remove('badge-warning', 'badge-success');
                savedIndicator.classList.add('badge-danger');
            }
        })
        .catch(error => {
            console.error('Error saving price:', error);
            savedIndicator.textContent = 'Failed';
            savedIndicator.classList.remove('badge-warning', 'badge-success');
            savedIndicator.classList.add('badge-danger');
        });
    }
  
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    
    fetchPriceHistory();
    connectWebSocket();
   
    setInterval(updateSecondsAgo, 1000);

    setInterval(() => {
        fetchPriceHistory(currentPage);
    }, 30000);
});
</script>
{% endblock %}
