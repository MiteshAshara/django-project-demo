<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Your Website Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

<!-- Add this right after the opening <body> tag or in your header section -->

<div id="live-price-header" style="background-color: #343a40; color: #fff; padding: 10px 0; text-align: center;">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <strong>Current Live Price: </strong>
                <span id="header-live-price">Loading...</span>
                <small id="save-status" class="ml-2" style="display: none;">(Saving...)</small>
            </div>
        </div>
    </div>
</div>

<!-- Replace the simple table with an enhanced data table -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <!-- Latest price card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="m-0">Latest Price Update</h3>
                </div>
                <div class="card-body text-center">
                    <h2 id="latest-price-display">Loading...</h2>
                    <p class="text-muted">Last updated: <span id="latest-update-time">--:--:--</span></p>
                </div>
            </div>
            
            <!-- Price history table -->
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between">
                    <h3 class="m-0">Price History</h3>
                    <span id="record-count" class="badge badge-light">Loading...</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Price (USDT)</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Seconds Ago</th>
                                </tr>
                            </thead>
                            <tbody id="price-table-body">
                                <tr>
                                    <td colspan="5" class="text-center">Loading price data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <nav aria-label="Price history pagination">
                        <ul id="pagination" class="pagination justify-content-center mb-0"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Function to store ALL price updates in database
    function storePriceInDatabase(price) {
        const saveStatus = document.getElementById('save-status');
        saveStatus.style.display = 'inline';
        
        fetch('/ticktable/api/update-price/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ price: price })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log('Price stored in database:', data);
            saveStatus.textContent = '(Saved)';
            
            // Reset status message after 2 seconds
            setTimeout(() => {
                saveStatus.style.display = 'none';
                saveStatus.textContent = '(Saving...)';
            }, 2000);
        })
        .catch(error => {
            console.error('Error storing price:', error);
            saveStatus.textContent = '(Save failed)';
            saveStatus.style.color = 'red';
            
            // Reset status message after 2 seconds
            setTimeout(() => {
                saveStatus.style.display = 'none';
                saveStatus.style.color = 'white';
                saveStatus.textContent = '(Saving...)';
            }, 2000);
        });
    }
    
    // Live price ticker with WebSocket connection - store EVERY update
    document.addEventListener('DOMContentLoaded', function() {
        const headerPriceElement = document.getElementById('header-live-price');
        
        if (headerPriceElement) {
            const socket = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                const price = parseFloat(data.c);
                
                // Show full price with 10 decimal places
                headerPriceElement.textContent = price.toFixed(10);
                
                // Update color based on price change
                if (parseFloat(data.p) >= 0) {
                    headerPriceElement.classList.remove('text-danger');
                    headerPriceElement.classList.add('text-success');
                } else {
                    headerPriceElement.classList.remove('text-success');
                    headerPriceElement.classList.add('text-danger');
                }
                
                // Store EVERY price update in database
                storePriceInDatabase(price);
            };
            
            socket.onerror = function() {
                headerPriceElement.textContent = 'Error';
            };
            
            socket.onclose = function() {
                headerPriceElement.textContent = 'Disconnected';
                
                // Try to reconnect after delay
                setTimeout(function() {
                    location.reload();
                }, 30000);
            };
        }
    });
    
    // Price table functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for price history table
        const priceTableBody = document.getElementById('price-table-body');
        const paginationElement = document.getElementById('pagination');
        const recordCountElement = document.getElementById('record-count');
        const latestPriceDisplay = document.getElementById('latest-price-display');
        const latestUpdateTime = document.getElementById('latest-update-time');
        
        let currentPage = 1;
        let totalPages = 1;
        let priceData = [];
        
        // Function to load price data
        function loadPriceData(page = 1) {
            fetch(`/ticktable/api/price-history/?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    priceData = data.prices;
                    currentPage = data.current_page;
                    totalPages = data.total_pages;
                    
                    // Update record count
                    recordCountElement.textContent = `${data.total_entries} Records`;
                    
                    // Update table
                    updateTable();
                    
                    // Update pagination
                    updatePagination();
                    
                    // Update latest price display if needed
                    if (data.prices.length > 0) {
                        const latest = data.prices[0];
                        latestPriceDisplay.textContent = parseFloat(latest.live_price).toFixed(10);
                        latestUpdateTime.textContent = formatTime(latest.timestamp);
                    }
                })
                .catch(error => {
                    console.error('Error loading price data:', error);
                    priceTableBody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                Failed to load price data. Please try again.
                            </td>
                        </tr>
                    `;
                });
        }
        
        // Format timestamp to readable format
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString();
        }
        
        // Calculate seconds ago from timestamp
        function getSecondsAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            return Math.round((now - then) / 1000);
        }
        
        // Update the price table
        function updateTable() {
            if (priceData.length === 0) {
                priceTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">No price data available</td>
                    </tr>
                `;
                return;
            }
            
            let tableHtml = '';
            
            priceData.forEach(price => {
                const dateObj = new Date(price.timestamp);
                const formattedDate = dateObj.toLocaleDateString();
                const formattedTime = dateObj.toLocaleTimeString();
                const secondsAgo = getSecondsAgo(price.timestamp);
                
                tableHtml += `
                    <tr>
                        <td>${price.id}</td>
                        <td>${parseFloat(price.live_price).toFixed(10)}</td>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td class="seconds-ago" data-timestamp="${price.timestamp}">${secondsAgo} seconds ago</td>
                    </tr>
                `;
            });
            
            priceTableBody.innerHTML = tableHtml;
        }
        
        // Update the pagination controls
        function updatePagination() {
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="1">&laquo; First</a>
                </li>
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                </li>
            `;
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${totalPages}">Last &raquo;</a>
                </li>
            `;
            
            paginationElement.innerHTML = paginationHtml;
            
            // Add click handlers to pagination links
            document.querySelectorAll('#pagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    loadPriceData(page);
                });
            });
        }
        
        // Update "seconds ago" values every second
        function updateSecondsAgo() {
            document.querySelectorAll('.seconds-ago').forEach(cell => {
                const timestamp = cell.getAttribute('data-timestamp');
                const secondsAgo = getSecondsAgo(timestamp);
                cell.textContent = `${secondsAgo} seconds ago`;
            });
        }
        
        // Initial data load
        loadPriceData();
        
        // Refresh data every 30 seconds
        setInterval(() => {
            loadPriceData(currentPage);
        }, 30000);
        
        // Update "seconds ago" every second
        setInterval(updateSecondsAgo, 1000);
        
        // Hook into WebSocket price updates to refresh first page if needed
        const existingOnMessage = socket.onmessage;
        socket.onmessage = function(event) {
            // Call the existing handler
            if (existingOnMessage) {
                existingOnMessage.call(this, event);
            }
            
            // If we're on the first page, refresh the data to show the new price
            if (currentPage === 1) {
                loadPriceData(1);
            }
            
            // Update the latest price display
            const data = JSON.parse(event.data);
            const price = parseFloat(data.c);
            latestPriceDisplay.textContent = price.toFixed(10);
            latestUpdateTime.textContent = new Date().toLocaleTimeString();
        };
    });
</script>
</body>
</html>
